<html>
<head>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <script src="https://trello.com/power-ups/power-up.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://api.trello.com/1/client.js?key=1a674bbe510eca060f24943e358b76ca"></script>
    <script src="wms-capabilities-parser.js"></script>
    <script src="wms-url-builder.js"></script>
</head>
<body>
<div id="formView" style="display: block;">
    <form id="urlForm">
        <label for="getCapabilitiesUrl">WMS GetCapabilities URL B:</label>
        <input name="getCapabilitiesUrl" id="getCapabilitiesUrl" type="text">
        <button type="submit" class="mod-primary">Load</button>
    </form>
</div>
<div id="errorView" style="display: none;">
    <form id="errorForm">
        <p id="errorMessage"></p>
        <button type="submit" class="mod-primary">Try Again</button>
    </form>
</div>
<script>
    var t = TrelloPowerUp.iframe();

    var callCounter = 0;

    const BOARD_ID = t.args[0].context.board;

    function authorizeTrelloUser() {
        Trello.authorize({
            type: 'popup',
            name: 'WMS Preview',
            scope: {
                read: 'true',
                write: 'true'
            },
            expiration: 'never',
            success: function () {
            },
            error: function (error) {
                console.error('Failed authentication', error);
            }
        });
    }
    authorizeTrelloUser();

    $('#urlForm').on('submit', function (event) {
        event.preventDefault();
        var getCapabilitiesUrl = window.getCapabilitiesUrl.value;
        // TODO: validate https; validate 1.3.0

        callCounter++;
        $.ajax({
            url: getCapabilitiesUrl,
            dataType: "xml",
            success: function (xmlBody) {
                var wmsCapabilities = new GetCapabilitiesParser().parse(xmlBody);
                if (wmsCapabilities.version !== '1.3.0') {
                    displayErrorMessage('The WMS Service must be in Version 1.3.0 but is '+wmsCapabilities.version);
                    callCounter--;
                    return;
                }
                createWmsList(wmsCapabilities, getCapabilitiesUrl);
                tryToClosePopup();
                callCounter--;
            },
            error: function (error) {
                console.error('Unable to load GetCapabilities document: ', error);
                displayErrorMessage('Unable to load GetCapabilities document: '+error.statusText);
                callCounter--;

            }
        });

    });

    function createWmsList(wmsCapabilities, getCapabilitiesUrl) {
        var newList = {
            idBoard: BOARD_ID,
            name: wmsCapabilities.name + ' - ' + wmsCapabilities.title,
            pos: 'top'
        };
        callCounter++;
        Trello.post(
            '/lists/',
            newList,
            function (data) {
                var idList = data.id;
                createWmsCards(idList, wmsCapabilities, getCapabilitiesUrl);
                callCounter--;
            },
            function (error) {
                console.error('cannot create list', error);
                callCounter--;
            });
    }

    function createWmsCards(idList, wmsCapabilities, getCapabilitiesUrl) {
        wmsCapabilities.layers.forEach(function (layer) {
            var newCard = {
                name: layer.name + ' - ' + layer.title,
                desc: function () {
                    var text = [
                        'layer name: ' + layer.name,
                        'layer title: ' + layer.title,
                        'GetCapabilities : ' + getCapabilitiesUrl,
                        'GetMap World: ' + createGetMapUrl(wmsCapabilities, layer)
                    ];
                    if (wmsCapabilities.getLegendGraphic !== undefined) {
                        text.push('GetLegendGraphic World: ' + createGetLegendGraphicUrl(wmsCapabilities, layer));
                    } else {
                        text.push('GetLegendGraphic request not provided by that service');
                    }
                    return text.join('\n\n');
                },
                idList: idList,
                pos: 'bottom'
            };
            callCounter++;
            Trello.post(
                '/cards/',
                newCard,
                function (data) {
                    createGetMapAttachment(data.id, wmsCapabilities, layer);
                    callCounter--;
                },
                function (error) {
                    console.error('cannot create card', error);
                    callCounter--;
                });
        });
    }

    function createGetMapAttachment(idCard, wmsCapabilities, layer) {
        var newAttachment = {
            url: createGetMapUrl(wmsCapabilities, layer),
            name: 'GetMap - World'
        };
        callCounter++;
        Trello.post(
            '/cards/' + idCard + '/attachments',
            newAttachment,
            function (data) {
                if (wmsCapabilities.getLegendGraphic !== undefined) {
                    createGetLegendGraphicAttachment(idCard, wmsCapabilities, layer);
                }
                callCounter--;
            },
            function (error) {
                console.error('cannot create GetMap attachment', error);
                callCounter--;
            });
    }

    function createGetLegendGraphicAttachment(idCard, wmsCapabilities, layer) {
        var newAttachment = {
            url: createGetLegendGraphicUrl(wmsCapabilities, layer),
            name: 'GetLegendGraphic'
        };
        callCounter++;
        Trello.post(
            '/cards/' + idCard + '/attachments',
            newAttachment,
            function (data) {
                callCounter--;
            },
            function (error) {
                console.error('cannot create GetLegendGraphic attachment', error);
                callCounter--;
            });
    }

    function tryToClosePopup() {
        console.log('tryToClosePopup()', callCounter);
        if (callCounter === 0) {
            console.log('close!');
            t.closePopup();
        } else {
            console.log('cannot close: ' + callCounter + 'calls are running!');
            setTimeout(tryToClosePopup, 500);
        }
    }

    function displayErrorMessage(errorMessage) {
        console.log('displayErrorMessage()', errorMessage);
        $('#errorMessage').text(errorMessage);
        $('#formView').hide();
        $('#errorView').show();
    }

    $('#errorForm').on('submit', function (event) {
        event.preventDefault();
        $('#errorView').hide();
        $('#formView').show();
    });

</script>
</body>
</html>