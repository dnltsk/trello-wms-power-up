<html>
<head>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <script src="https://trello.com/power-ups/power-up.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://api.trello.com/1/client.js?key=1a674bbe510eca060f24943e358b76ca"></script>
</head>
<body>
<form id="urlForm">
    <label for="url">WMS GetCapabilities URL D:</label>
    <input name="url" id="url" type="text">
    <button type="submit" class="mod-primary">Save</button>
</form>
<script>
    var t = TrelloPowerUp.iframe();

    console.log('t', t);
    console.log('t.io.hostHandlers', t.io.hostHandlers);

    console.log('Trello', Trello);

    const BOARD_ID = t.args[0].context.board;
    const TOKEN = t.secret;

    authorizeTrelloUser();

    window.urlForm.addEventListener('submit', function (event) {
        event.preventDefault();
        var url = window.url.value;
        console.log('url', url);
        // TODO: validate https; validate 1.3.0


        createWmsList("foo");
        //createWmsLayerPreviewCard("foo");

//        $.ajax({
//            url: url,
//            dataType: "xml",
//            success: function (gc) {
//                $(gc).find('Layer').each(function () {
//                    var name = $(this).find("Name").text();
//                    console.log(name);
//                });
//
//                t.closePopup();
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                console.error('error in getCapabilities loading', url);
//                t.closePopup();
//            }
//        });

    });

    function authorizeTrelloUser() {
        Trello.authorize({
            type: 'popup',
            name: 'Getting Started Application',
            scope: {
                read: 'true',
                write: 'true'
            },
            expiration: 'never',
            success: function () {
                console.log('Successful authentication');
            },
            error: function () {
                console.log('Failed authentication');
            }
        });
    }

    function createWmsList(listName) {
        var newCard = {
            name: listName,
            pos: 'top'
        };
        Trello.post(
            '/lists/',
            newCard,
            function (data) {
                console.log('List created successfully. Data returned:' + JSON.stringify(data));
            });
    }

    function createWmsLayerPreviewCard(layerName) {
        //var destinationList = "YA902M72";
        var destinationList = "bar";

        var newCard = {
            name: layerName,
            desc: "Using the Trello API is fun and easy!",
            pos: "top",
            due: null,
            idList: destinationList
        };

        $.ajax({
            url: 'https://api.trello.com/1/cards' +
            '?key=1a674bbe510eca060f24943e358b76ca' +
            //'&token=jwgAQ7Kp44NcuiJ17xJ8w3xqSZ8BR6NDXn5eR0AFMOVf9sz9aUDfxCOCf16vkMkz' +
            '&name=' + layerName +
            '&desc=newCarddescription' +
            '&idList=' + destinationList,
            type: "POST",
            data: newCard,
            success: function (data) {
                console.log("success create card", data);
            },
            error: function (error) {
                console.error("cannot create card", error);
                window.exx = error;
            }
        });
    }


</script>
</body>
</html>