<html>
<head>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <script src="https://trello.com/power-ups/power-up.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://api.trello.com/1/client.js?key=1a674bbe510eca060f24943e358b76ca"></script>
</head>
<body>
<form id="urlForm">
    <label for="url">WMS GetCapabilities URL C:</label>
    <input name="url" id="url" type="text">
    <button type="submit" class="mod-primary">Save</button>
</form>
<script>
    var t = TrelloPowerUp.iframe();

    const BOARD_ID = t.args[0].context.board;
    const TOKEN = t.secret;

    authorizeTrelloUser();

    window.urlForm.addEventListener('submit', function (event) {
        event.preventDefault();
        var url = window.url.value;
        console.log('url', url);
        // TODO: validate https; validate 1.3.0


        $.ajax({
            url: url,
            dataType: "xml",
            success: function (gc) {

                var wmsCapabilities = {
                    'service': {
                        'name': $(gc).find('Service').find('Name').text(),
                        'title': $(gc).find('Service').find('Title').text()
                    }
                };

                var layers = [];
                $(gc).find('Layer Layer').each(function () {
                    layers.push({
                        'name': $(this).find("Name").text(),
                        'title': $(this).find("Title").text()
                    })
                });

                wmsCapabilities.layers = layers;

                createWmsList(wmsCapabilities);

                //t.closePopup();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('error in getCapabilities loading', url);
                t.closePopup();
            }
        });

    });

    function authorizeTrelloUser() {
        Trello.authorize({
            type: 'popup',
            name: 'Getting Started Application',
            scope: {
                read: 'true',
                write: 'true'
            },
            expiration: 'never',
            success: function () {
                console.log('Successful authentication');
            },
            error: function () {
                console.log('Failed authentication');
            }
        });
    }

    function createWmsList(wmsCapabilities) {
        var newList = {
            idBoard: BOARD_ID,
            name: wmsCapabilities.service.name + ' - ' + wmsCapabilities.service.title,
            pos: 'top'
        };
        Trello.post(
            '/lists/',
            newList,
            function (data) {
                console.log('List created successfully. Data returned:' + JSON.stringify());
                var idList = data.id;
                createWmsCards(idList, wmsCapabilities);
            });
    }

    function createWmsCards(idList, wmsCapabilities) {
        wmsCapabilities.layers.forEach(function (layer) {
            var newCard = {
                name: layer.name + ' - ' + layer.title,
                desc: function () {
                    return [
                        JSON.stringify(layer),
                        'GetMap World: ' + createGetMapUrl(wmsCapabilities, layer),
                        'GetLegendGraphic World: ' + createGetLegendGraphicUrl(wmsCapabilities, layer)
                    ].join('\n\n');
                },
                idList: idList,
                pos: 'bottom'
            };
            Trello.post(
                '/cards/',
                newCard,
                function (data) {
                    console.log('Card created successfully. Data returned:' + JSON.stringify(data));
                    createGetMapAttachment(data.id, wmsCapabilities, layer);
                });
        });
    }

    function createGetMapAttachment(idCard, wmsCapabilities, layer) {
        var newAttachment = {
            url: createGetMapUrl(wmsCapabilities, layer),
            name: 'GetMap - World'
        };
        Trello.post(
            '/cards/' + idCard + '/attachments',
            newAttachment,
            function (data) {
                console.log('GetMap created successfully. Data returned:' + JSON.stringify(data));
                createGetLegendGraphicAttachment(idCard, wmsCapabilities, layer);
            });
    }

    function createGetLegendGraphicAttachment(idCard, wmsCapabilities, layer) {
        var newAttachment = {
            url: createGetMapUrl(wmsCapabilities, layer),
            name: 'GetLegendGraphic'
        };
        Trello.post(
            '/cards/' + idCard + '/attachments',
            newAttachment,
            function (data) {
                console.log('GetLegendGraphic created successfully. Data returned:' + JSON.stringify(data));
                createGetLegendGraphicAttachment(idCard, wmsCapabilities, layer);
            });
    }

    function createGetMapUrl(wmsCapabilities, layer) {
        return 'http://129.206.228.72/cached/osm/service?service=wms&version=1.1.1&request=GetMap&layers=' + layer.name + '&styles=&srs=EPSG:4326&bbox=-180,-90,180,90&width=1024&height=512&format=image/png'
    }
    function createGetLegendGraphicUrl(wmsCapabilities, layer) {
        return 'http://129.206.228.72/cached/osm/service?service=wms&version=1.1.1&request=GetLegendGraphic&layer=' + layer.name + '&format=image/png'
    }

</script>
</body>
</html>